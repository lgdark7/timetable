{% extends 'base.html' %}

{% block icon %}<i class="fas fa-edit"></i>{% endblock %}
{% block title %}Edit Timetable Entry{% endblock %}

{% block content %}
<div class="card" style="max-width: 600px; margin: 0 auto; padding: 40px;">
    <div class="card-header" style="margin-bottom: 30px;">
        <h3 style="margin: 0; color: var(--dark); font-weight: 700;">
            Reschedule Period
        </h3>
        <p style="color: var(--text-muted); margin-top: 10px;">Update the day, time, or classroom for this session.</p>
    </div>

    {% if conflict_reason %}
    <div class="alert alert-danger" role="alert"
        style="border-radius: 12px; border-left: 5px solid #ef4444; background: rgba(239, 68, 68, 0.1); color: #b91c1c;">
        <h4 style="font-size: 1rem; font-weight: 700; margin-bottom: 5px;"><i class="fas fa-exclamation-triangle"></i>
            Conflict Detected</h4>
        <p style="margin-bottom: 0;">{{ conflict_reason }}</p>
    </div>

    {% if suggestions %}
    <div style="margin-bottom: 30px; animation: fadeIn 0.5s ease;">
        <h5
            style="color: var(--text-muted); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px;">
            Suggested Alternatives</h5>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            {% for sug in suggestions %}
            <button type="button"
                onclick="applySuggestion('{{ sug.day }}', '{{ sug.timeslot }}', '{{ sug.classroom.id }}')"
                class="btn btn-outline-success"
                style="text-align: left; padding: 15px; border-radius: 10px; border: 1px solid #10b981; background: rgba(16, 185, 129, 0.05); color: var(--dark); transition: all 0.2s;">
                <div style="font-weight: 700; color: #059669; margin-bottom: 5px;">{{ sug.day }}</div>
                <div style="font-size: 1.1rem; font-weight: 800; margin-bottom: 5px;">{{ sug.timeslot }}</div>
                <div style="font-size: 0.85rem; color: var(--text-muted);"><i class="fas fa-door-open"></i> {{
                    sug.classroom.name }}</div>
            </button>
            {% endfor %}
        </div>
    </div>
    <script>
        function applySuggestion(day, timeslot, classroomId) {
            document.querySelector('select[name="day"]').value = day;
            document.querySelector('select[name="timeslot"]').value = timeslot;
            document.querySelector('select[name="classroom_id"]').value = classroomId;
            document.querySelector('button[type="submit"]').scrollIntoView({ behavior: 'smooth' });
            document.querySelector('form').style.opacity = '0.5';
            setTimeout(() => { document.querySelector('form').style.opacity = '1'; }, 200);
        }
    </script>
    {% endif %}
    {% endif %}

    <form action="{{ url_for('main.edit_timetable_entry', id=entry.id) }}" method="POST">
        <div class="form-group">
            <label class="form-label">Subject</label>
            <input type="text" class="form-control" value="{{ entry.course.name }} ({{ entry.course.code }})" disabled
                style="background: rgba(255,255,255,0.05); color: var(--text-muted);">
        </div>

        <div class="form-group" style="margin-top: 20px;">
            <label class="form-label">Day of the Week</label>
            <select name="day" class="form-control" required>
                {% for day in days %}
                <option value="{{ day }}" {% if day==entry.day %}selected{% endif %}>{{ day }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group" style="margin-top: 20px;">
            <label class="form-label">Timeslot</label>
            <select name="timeslot" class="form-control" required>
                {% for slot in time_slots %}
                <option value="{{ slot }}" {% if slot==entry.timeslot %}selected{% endif %}>{{ slot }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group" style="margin-top: 20px;">
            <label class="form-label">Classroom / Lab</label>
            <select name="classroom_id" class="form-control" required>
                {% for room in classrooms %}
                <option value="{{ room.id }}" {% if room.id==entry.classroom_id %}selected{% endif %}>
                    {{ room.name }} ({{ room.type }})
                </option>
                {% endfor %}
            </select>
        </div>

        {% if current_user.role == 'admin' %}
        <div class="form-group" style="margin-top: 20px;">
            <label class="form-label">Teacher</label>
            <select name="teacher_id" class="form-control" required>
                {% for teacher in teachers %}
                <option value="{{ teacher.id }}" {% if teacher.id==entry.teacher_id %}selected{% endif %}>
                    {{ teacher.name }} ({{ teacher.department.code if teacher.department else 'N/A' }})
                </option>
                {% endfor %}
            </select>
        </div>
        {% else %}
        <input type="hidden" name="teacher_id" value="{{ entry.teacher_id }}">
        {% endif %}

        <div style="display: flex; gap: 15px; margin-top: 40px;">
            <button type="submit" class="btn btn-primary" style="flex: 1; justify-content: center;">
                <i class="fas fa-save"></i> Save Changes
            </button>
            <a href="{{ url_for('main.timetable') }}" class="btn btn-light" style="flex: 1; justify-content: center;">
                Cancel
            </a>
        </div>
    </form>
</div>
{% endblock %}