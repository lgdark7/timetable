{% extends 'base.html' %}

{% block icon %}<i class="fas fa-table"></i>{% endblock %}
{% block title %}Weekly Timetables{% endblock %}

{% block content %}
<div class="action-header"
    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
    <div style="display: flex; gap: 15px;">
        <input type="text" id="deptSearch" class="form-control" placeholder="Search department..."
            style="max-width: 250px;">
    </div>
    <div style="display: flex; gap: 10px;">
        {% if current_user.role == 'admin' %}
        <form action="{{ url_for('main.clear_timetable') }}" method="POST"
            onsubmit="return confirm('Are you sure you want to delete ALL timetable entries? This cannot be undone.');">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-trash-alt"></i> Clear Timetable
            </button>
        </form>
        {% endif %}
        <button onclick="downloadPDF()" class="btn btn-primary">
            <i class="fas fa-file-pdf"></i> Download PDF
        </button>
        <a href="{{ url_for('main.timetable') }}" class="btn btn-light">
            <i class="fas fa-sync"></i> Refresh
        </a>
    </div>
</div>

<div id="timetable-content">
    {% if teacher_schedule %}
    {# TEACHER DEDICATED VIEW #}
    <div class="card timetable-card teacher-highlight"
        style="padding: 15px; margin-bottom: 50px; border: 2px solid var(--primary);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <h3 style="margin: 0; color: var(--dark); font-weight: 700;">
                <i class="fas fa-user-tie"></i> Your Personal Schedule: {{ teacher_profile.name }}
            </h3>
            <div style="display: flex; gap: 10px; align-items: center;">
                <span class="badge badge-teacher" style="color: #fff; padding: 8px 15px; font-size: 0.8rem;">
                    <i class="fas fa-star"></i> Interactive Weekly Overview
                </span>
                <button onclick="downloadSinglePDF('Teacher_{{ teacher_profile.name }}', 'teacher-timetable-card')"
                    class="btn btn-sm btn-light no-pdf"
                    style="padding: 6px 12px; border: 1px solid #e2e8f0; border-radius: 8px;">
                    <i class="fas fa-file-pdf" style="color: #e11d48; margin-right: 5px;"></i> Download My PDF
                </button>
            </div>
        </div>

        <div class="timetable-responsive" id="teacher-timetable-card">
            <table class="timetable-table">
                <thead>
                    <tr>
                        <th class="day-header">Day / Time</th>
                        {% for t in time_slots %}
                        <th>{{ t }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for day in days %}
                    <tr>
                        <td class="day-header">{{ day }}</td>
                        {% for cell in teacher_schedule[day] %}
                        {% if not cell.skip %}
                        {% set is_practical = cell.entries and cell.entries[0].course.type == 'Practical' %}
                        <td colspan="{{ cell.colspan }}" class="{{ 'practical-session' if is_practical }} my-session">
                            {% if cell.entries %}
                            {% for entry in cell.entries %}
                            <div class="my-session-inner"
                                style="{{ 'padding: 3px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 3px;' if not loop.last else 'padding: 3px;' }}">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                    <div style="font-weight: 700; color: var(--primary); font-size: 0.95rem;">
                                        {{ entry.course.code }}
                                    </div>
                                    <a href="{{ url_for('main.edit_timetable_entry', id=entry.id) }}" class="no-pdf"
                                        style="color: var(--text-muted); font-size: 0.8rem; opacity: 0.6;">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </div>
                                <div style="font-size: 0.75rem; color: var(--white); margin: 2px 0; opacity: 0.9;">
                                    {{ entry.department.code }} (Sec {{ entry.department.section }}) - {{
                                    entry.classroom.name }}
                                </div>
                                {% if entry.course.type == 'Practical' %}
                                <span
                                    style="font-size: 0.65rem; color: var(--secondary); text-transform: uppercase; font-weight: 800;">[
                                    Lab ]</span>
                                {% endif %}
                            </div>
                            {% endfor %}
                            {% else %}
                            <span style="color: #adb5bd;">-</span>
                            {% endif %}
                        </td>
                        {% endif %}
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="section-divider"
        style="margin-bottom: 30px; text-align: center; border-bottom: 1px solid var(--border-color); position: relative;">
        <span
            style="background: var(--bg-main); padding: 0 20px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 2px; position: relative; top: 12px;">Regular
            Departmental Timetables</span>
    </div>
    {% endif %}

    {# ALWAYS SHOW DEPARTMENTAL VIEW (FOR SEARCH/REGULAR VIEW) #}
    {% for dept, schedule in timetable_data.items() %}
    {% set is_student_link = (current_user.role == 'student' and current_user.dept_id == dept.id) %}
    {% set is_teacher_link = (current_user.role == 'teacher' and current_user.dept_id == dept.id) %}

    <div class="card timetable-card {{ 'student-highlight' if is_student_link }} {{ 'teacher-highlight' if is_teacher_link }}"
        id="dept-card-{{ dept.id }}" data-dept="{{ dept.name|lower }}" style="padding: 15px; page-break-after: always;">

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <h3 style="margin: 0; color: var(--dark); font-weight: 700;">
                {{ dept.name }} - {{ dept.code }} ({{ dept.semester }} - Section {{ dept.section }})
            </h3>
            <div style="display: flex; gap: 10px; align-items: center;">
                {% if current_user.dept_id == dept.id %}
                <span class="badge {{ 'badge-student' if current_user.role == 'student' else 'badge-teacher' }}"
                    style="color: #fff; padding: 8px 15px; font-size: 0.8rem;">
                    <i class="fas fa-star"></i> Your Schedule
                </span>
                {% endif %}
                <button
                    onclick="downloadSinglePDF('{{ dept.code }}-S{{ dept.semester }}-{{ dept.section }}', 'dept-card-{{ dept.id }}')"
                    class="btn btn-sm btn-light no-pdf"
                    style="padding: 6px 12px; border: 1px solid #e2e8f0; border-radius: 8px;">
                    <i class="fas fa-file-pdf" style="color: #e11d48; margin-right: 5px;"></i> Download PDF
                </button>
            </div>
        </div>

        <div class="timetable-responsive">
            <table class="timetable-table">
                <thead>
                    <tr>
                        <th class="day-header">Day / Time</th>
                        {% for t in time_slots %}
                        <th>{{ t }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for day in days %}
                    <tr>
                        <td class="day-header">{{ day }}</td>
                        {% for cell in schedule[day] %}
                        {% if not cell.skip %}
                        {% set is_practical = cell.entries and cell.entries[0].course.type == 'Practical' %}
                        {% set ns = namespace(is_mine=false) %}
                        {% if cell.entries and current_user.role == 'teacher' %}
                        {% for entry in cell.entries %}
                        {% if entry.teacher_id == current_user.teacher_id %}
                        {% set ns.is_mine = true %}
                        {% endif %}
                        {% endfor %}
                        {% endif %}

                        <td colspan="{{ cell.colspan }}"
                            class="{{ 'practical-session' if is_practical }} {{ 'my-session' if ns.is_mine }}">
                            {% if cell.entries %}
                            {% for entry in cell.entries %}
                            {% set is_my_sess = (current_user.role == 'teacher' and entry.teacher_id ==
                            current_user.teacher_id) %}
                            <div class="{{ 'my-session-inner' if is_my_sess }}"
                                style="{{ 'padding: 3px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 3px;' if not loop.last else 'padding: 3px;' }}">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                    <div style="font-weight: 700; color: var(--primary); font-size: 0.95rem;">{{
                                        entry.course.code }}</div>
                                    {% if current_user.role == 'admin' or is_my_sess %}
                                    <a href="{{ url_for('main.edit_timetable_entry', id=entry.id) }}" class="no-pdf"
                                        style="color: var(--text-muted); font-size: 0.8rem; opacity: 0.6; transition: var(--transition-smooth);"
                                        onmouseover="this.style.opacity='1'; this.style.color='var(--primary)'"
                                        onmouseout="this.style.opacity='0.6'; this.style.color='var(--text-muted)'">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    {% endif %}
                                </div>
                                <div style="font-size: 0.75rem; color: var(--white); margin: 2px 0; opacity: 0.9;">{{
                                    entry.classroom.name }}</div>
                                <div style="font-size: 0.7rem; color: var(--text-muted);">{{ entry.teacher.name }}
                                </div>
                                {% if entry.course.type == 'Practical' %}
                                <span
                                    style="font-size: 0.65rem; color: var(--secondary); text-transform: uppercase; font-weight: 800;">[
                                    Lab ]</span>
                                {% endif %}
                            </div>
                            {% endfor %}
                            {% else %}
                            <span style="color: #adb5bd;">-</span>
                            {% endif %}
                        </td>
                        {% endif %}
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endfor %}
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
    function downloadPDF() {
        const element = document.getElementById('timetable-content');

        // Add compact class for PDF generation
        document.body.classList.add('pdf-compact');

        const opt = {
            margin: [5, 5],
            filename: 'Timetable_Complete_{{ current_user.username }}.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' },
            pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
        };

        html2pdf().set(opt).from(element).save().then(() => {
            // Remove compact class after generation
            document.body.classList.remove('pdf-compact');
        });
    }

    function downloadSinglePDF(filename, elementId) {
        const element = document.getElementById(elementId);

        // Add compact class for PDF generation
        document.body.classList.add('pdf-compact');

        const opt = {
            margin: [10, 10],
            filename: `Timetable_${filename}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 1.5 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
        };

        html2pdf().set(opt).from(element).save().then(() => {
            // Remove compact class after generation
            document.body.classList.remove('pdf-compact');
        });
    }

    // Search functionality with auto-filter
    const searchInput = document.getElementById('deptSearch');

    function applyFilter(term) {
        const cards = document.querySelectorAll('.timetable-card');
        cards.forEach(card => {
            const dept = card.getAttribute('data-dept');
            if (!dept) return; // Keep personal schedule visible
            if (dept.includes(term.toLowerCase())) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }

    searchInput.addEventListener('input', (e) => applyFilter(e.target.value));

    // Auto-filter on load for students/teachers
    window.addEventListener('load', () => {
        const autoFilterDept = document.getElementById('user-dept-name')?.value;
        if (autoFilterDept) {
            searchInput.value = autoFilterDept;
            applyFilter(autoFilterDept);
        }
    });
</script>

{% if current_user.department %}
<input type="hidden" id="user-dept-name" value="{{ current_user.department.name }}">
{% endif %}
{% endblock %}