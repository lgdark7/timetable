{% extends 'base.html' %}

{% block icon %}<i class="fas fa-th-large"></i>{% endblock %}
{% block title %}System Overview{% endblock %}

{% block content %}
<div class="welcome-banner"
    style="margin-bottom: 30px; padding: 40px; background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1)); border-radius: 24px; border: 1px solid rgba(255,255,255,0.05); position: relative; overflow: hidden; animation: pageEnter 0.6s ease-out;">

    <div
        style="display: flex; justify-content: space-between; align-items: flex-start; position: relative; z-index: 2; flex-wrap: wrap; gap: 20px;">
        <div style="flex: 1;">
            <h2 style="font-size: 2rem; font-weight: 800; margin-bottom: 10px; color: var(--text-main);">Welcome Back,
                {{
                current_user.username }}!</h2>
            <p style="color: var(--text-muted); font-size: 1.1rem; max-width: 600px;">Your intelligent scheduling
                environment is active. All secondary constraints and parities are currently satisfied.</p>
        </div>

        <div
            style="background: rgba(0,0,0,0.2); padding: 15px 25px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(5px);">
            <div style="font-size: 0.8rem; text-transform: uppercase; color: var(--text-muted); font-weight: 600;">
                Current Session</div>
            <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);" id="dashboardTime">Loading...</div>
            <div style="font-size: 0.9rem; color: var(--text-main); margin-top: 5px;" id="dashboardDate"></div>
        </div>
    </div>

    <div
        style="position: absolute; right: -50px; bottom: -50px; font-size: 15rem; color: rgba(255,255,255,0.03); transform: rotate(-15deg);">
        <i class="fas fa-calendar-check"></i>
    </div>
</div>

<script>
    function updateTime() {
        const now = new Date();
        document.getElementById('dashboardTime').textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        document.getElementById('dashboardDate').textContent = now.toLocaleDateString([], { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }
    updateTime();
    setInterval(updateTime, 1000);
</script>
<div class="status-bar" style="display: flex; gap: 20px; margin-bottom: 30px; animation: fadeIn 1s ease;">
    <div class="card"
        style="flex: 1; padding: 15px 25px; margin-bottom: 0; display: flex; align-items: center; justify-content: space-between; border-left: 4px solid #10b981;">
        <div>
            <span
                style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px;">System
                Status</span>
            <div style="font-weight: 700; color: #10b981;"><i class="fas fa-check-circle"></i> Fully Optimized</div>
        </div>
        <div class="pulse"
            style="width: 10px; height: 10px; background: #10b981; border-radius: 50%; box-shadow: 0 0 10px #10b981;">
        </div>
    </div>
    <div class="card"
        style="flex: 1; padding: 15px 25px; margin-bottom: 0; display: flex; align-items: center; justify-content: space-between; border-left: 4px solid var(--primary);">
        <div>
            <span
                style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px;">Clash
                Detection</span>
            <div style="font-weight: 700; color: var(--text-main);">0 Conflicts Found</div>
        </div>
        <i class="fas fa-shield-virus" style="color: var(--primary); opacity: 0.5;"></i>
    </div>
    <div class="card"
        style="flex: 1; padding: 15px 25px; margin-bottom: 0; display: flex; align-items: center; justify-content: space-between; border-left: 4px solid #f59e0b;">
        <div>
            <span
                style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px;">Intelligence
                Score</span>
            <div style="font-weight: 700; color: #f59e0b;">98.4%</div>
        </div>
        <i class="fas fa-chart-line" style="color: #f59e0b; opacity: 0.5;"></i>
    </div>
</div>

<div class="upload-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
    <div class="card" style="text-align: center;">
        <i class="fas fa-building text-primary" style="font-size: 2rem; margin-bottom: 15px;"></i>
        <h3 style="font-size: 0.9rem; color: var(--gray);">Departments</h3>
        <p style="font-size: 1.8rem; font-weight: 700; margin: 10px 0;">{{ counts.departments }}</p>
        <a href="{{ url_for('main.departments') }}" class="btn btn-light btn-sm" style="font-size: 0.8rem;">View All</a>
    </div>

    <div class="card" style="text-align: center;">
        <i class="fas fa-user-tie text-success" style="font-size: 2rem; margin-bottom: 15px;"></i>
        <h3 style="font-size: 0.9rem; color: var(--gray);">Teachers</h3>
        <p style="font-size: 1.8rem; font-weight: 700; margin: 10px 0;">{{ counts.teachers }}</p>
        <a href="{{ url_for('main.teachers') }}" class="btn btn-light btn-sm" style="font-size: 0.8rem;">View All</a>
    </div>

    <div class="card" style="text-align: center;">
        <i class="fas fa-book text-warning" style="font-size: 2rem; margin-bottom: 15px;"></i>
        <h3 style="font-size: 0.9rem; color: var(--gray);">Subjects</h3>
        <p style="font-size: 1.8rem; font-weight: 700; margin: 10px 0;">{{ counts.courses }}</p>
        <a href="{{ url_for('main.courses') }}" class="btn btn-light btn-sm" style="font-size: 0.8rem;">View All</a>
    </div>

    <div class="card" style="text-align: center;">
        <i class="fas fa-door-open text-danger" style="font-size: 2rem; margin-bottom: 15px;"></i>
        <h3 style="font-size: 0.9rem; color: var(--gray);">Classrooms</h3>
        <p style="font-size: 1.8rem; font-weight: 700; margin: 10px 0;">{{ counts.classrooms }}</p>
        <a href="{{ url_for('main.classrooms') }}" class="btn btn-light btn-sm" style="font-size: 0.8rem;">View All</a>
    </div>
</div>

{% if current_user.role == 'admin' %}
<div class="card">
    <div class="card-header">
        <h3><i class="fas fa-tasks"></i> Quick Actions</h3>
    </div>
    <div style="display: flex; gap: 15px;">
        <form action="{{ url_for('main.generate') }}" method="POST">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-magic"></i> Generate Timetable
            </button>
        </form>
        <a href="{{ url_for('main.admin_leaves') }}" class="btn btn-warning">
            <i class="fas fa-calendar-check"></i> Leave Requests
        </a>
        <a href="{{ url_for('main.upload_csv') }}" class="btn btn-light">
            <i class="fas fa-file-upload"></i> Bulk Data Upload
        </a>
    </div>
</div>

<div class="card" style="margin-top: 30px; border-left: 4px solid var(--primary);">
    <div class="card-header">
        <h3><i class="fas fa-brain"></i> System Intelligence Highlights</h3>
    </div>
    <div
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; padding: 10px 0;">
        <div style="padding: 15px; background: rgba(99, 102, 241, 0.05); border-radius: 12px;">
            <h4 style="color: var(--primary); font-size: 0.95rem; margin-bottom: 8px;"><i class="fas fa-shield-alt"></i>
                Triple-Conflict Prevention</h4>
            <p style="font-size: 0.82rem; color: var(--text-muted); line-height: 1.5;">Simultaneously validates Teacher
                availability, Classroom capacity, and Department batch constraints to ensure zero clashes.</p>
        </div>
        <div style="padding: 15px; background: rgba(16, 185, 129, 0.05); border-radius: 12px;">
            <h4 style="color: #10b981; font-size: 0.95rem; margin-bottom: 8px;"><i class="fas fa-microscope"></i>
                Intelligent Lab Allocation</h4>
            <p style="font-size: 0.82rem; color: var(--text-muted); line-height: 1.5;">Automatically schedules 3-period
                practical blocks at optimal start times (10:50 AM / 2:00 PM) for efficiency.</p>
        </div>
        <div style="padding: 15px; background: rgba(245, 158, 11, 0.05); border-radius: 12px;">
            <h4 style="color: #f59e0b; font-size: 0.95rem; margin-bottom: 8px;"><i class="fas fa-robot"></i> Smart
                Activity Logic</h4>
            <p style="font-size: 0.82rem; color: var(--text-muted); line-height: 1.5;">Dynamically assigns Activity
                classes to late-day slots and intelligently links them to the preceding subject's teacher.</p>
        </div>
    </div>
</div>
{% if current_user.role == 'teacher' %}
<div class="card">
    <div class="card-header" style="justify-content: space-between;">
        <h3><i class="fas fa-user-clock"></i> Leave & Substitutions</h3>
        <a href="{{ url_for('main.request_leave') }}" class="btn btn-primary btn-sm">Request Leave</a>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <!-- My Leaves -->
        <div>
            <h4 style="font-size: 1rem; margin-bottom: 10px; color: var(--text-muted);">My Upcoming Leaves</h4>
            {% if current_user.teacher_profile.leave_requests %}
            <ul style="list-style: none; padding: 0;">
                {% for leave in current_user.teacher_profile.leave_requests|reverse %}
                {% set status_color = '#f59e0b' %}
                {% if leave.status == 'Approved' %}{% set status_color = '#10b981' %}{% endif %}
                {% if leave.status == 'Rejected' %}{% set status_color = '#ef4444' %}{% endif %}
                <li
                    style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-bottom: 8px; font-size: 0.9rem; border-left: 3px solid {{ status_color }};">
                    <div style="font-weight: 600; display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span>{{ leave.date.strftime('%d %b, %Y') }}</span>
                        <span
                            style="font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: {{ status_color }}20; color: {{ status_color }}; border: 1px solid {{ status_color }};">
                            {{ leave.status }}
                        </span>
                    </div>
                    <div style="font-size: 0.8rem; opacity: 0.7; margin-bottom: 4px;">
                        <i class="fas fa-quote-left" style="font-size: 0.7rem; margin-right: 5px;"></i> {{ leave.reason
                        if leave.reason else 'No reason provided' }}
                    </div>
                    {% if leave.admin_response %}
                    <div
                        style="margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 0.8rem; color: {{ status_color }};">
                        <i class="fas fa-comment-dots"></i> <strong>Admin:</strong> {{ leave.admin_response }}
                    </div>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p style="font-size: 0.9rem; color: var(--text-muted); font-style: italic;">No leave requests found.</p>
            {% endif %}
        </div>

        <!-- My Substitutions -->
        <div>
            <h4 style="font-size: 1rem; margin-bottom: 10px; color: var(--text-muted);">Assigned Substitutions</h4>
            {% if current_user.teacher_profile.substitutions %}
            <ul style="list-style: none; padding: 0;">
                {% for sub in current_user.teacher_profile.substitutions %}
                <li
                    style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-bottom: 8px; font-size: 0.9rem; border-left: 3px solid #10b981;">
                    <div style="font-weight: 600;">{{ sub.leave_request.date.strftime('%d %b, %Y') }} at {{
                        sub.original_entry.timeslot }}</div>
                    <div style="font-size: 0.8rem;">
                        Covering for <span style="color: var(--primary);">{{ sub.original_entry.teacher.name }}</span>
                        <br>
                        Class: {{ sub.original_entry.course.name }} (Room {{ sub.original_entry.classroom.name }})
                    </div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p style="font-size: 0.9rem; color: var(--text-muted); font-style: italic;">No substitutions assigned.</p>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

{% endif %}
{% endblock %}